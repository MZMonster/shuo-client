!function(a){function b(){$sortList=a(".mws-sort-list"),$sortList.find('[data-sortby="new"]').addClass("mws-btn-sort-active").parent().siblings().find(".mws-btn-sort").removeClass("mws-btn-sort-active")}function c(){var a=[];a.push(shuo.options.sourceID),window.shuo.api.groupOfCmts(a.toString(),function(a,b){if(a)return console.log("load comment count error: ",a);var c;for(var d in b)b.hasOwnProperty(d)&&b[d].uuid===shuo.options.threadID&&(c=d)})}function d(){window.shuo.api.atSuggest(function(a,b){return a?console.log("get suggest error: ",a):void(x=b.suggest||[])})}function e(){var a="shuo_comment_"+shuo.options.threadID;localStorage&&localStorage.getItem(a)&&(v.find(".mws-cmt-form-wrapper .mws-editable").val(localStorage.getItem(a)),localStorage.removeItem(a,""))}function f(){var a=/(^|\?|&)shuo_cmt_id=([^&]*)(&|$)/,b=location.search,c=b.match(a);c&&(document.getElementById(c[2])?document.getElementById(c[2]).scrollIntoView(!0):l())}function g(){a(".mws-page-next").attr("data-page")>1&&(A.hasMore=!0)}function h(){var a=/=$/g,b=window.shuo.options.user_login_url;a.test(b)&&(b+=encodeURIComponent(window.location.href+"#"+window.shuo.options.target)),w='请先<a href="'+b+'">登录</a>'}function i(){var b=a(".mws-editable");window.shuo.options.cmt_title&&a("#SHUO_title").text(window.shuo.options.cmt_title),window.shuo.loginStatus?window.shuo.options.cmt_placeholder&&b.attr("placeholder",window.shuo.options.cmt_placeholder):b.attr("placeholder",z),!D&&b.addClass("focus")}function j(){var b=(a(this).parents(".mws-cmt-root"),a(y)),c=b.find(".mws-editable"),d=a(this).attr("data-to-username");return window.shuo.loginStatus?(c.attr("data-to",a(this).attr("data-to")),c.attr("data-parentid",a(this).attr("data-parentid")),c.focus(),void(d?(window.shuo.loginStatus&&c.attr("placeholder","回复"+d),c.val("").attr("to-username","@"+d+" : ")):c.val(""))):void a(a(this).parents(".mws-cmt-item").find(".mws-item-message")[0]).html(w)}function k(){var b=a(this),c=a(y),d=c.find(".mws-editable"),e=d.attr("data-parentID"),f=new RegExp("\n","g");if(!d.val().trim())return void c.find(".mws-form-message").html("未输入评论内容");if(window.shuo.loginStatus)E||(b.attr("disabled",!0),E=!0,window.shuo.api.submit({content:(d.attr("to-username")?d.attr("to-username"):"")+d.val().replace(f,"  \n"),parentID:d.attr("data-parentID"),replyTo:d.attr("data-to")},function(f,g){if(E=!1,b.removeAttr("disabled"),d.removeAttr("to-username"),f)return window.shuo.api.reqErrorHandle(f,function(a){c.find(".mws-form-message").text(a)});if(a(".mws-btn-submit-mobile").attr("disabled",!0),d.attr("data-parentID")){var h=(a("#"+e),a(g)),i=h.find(".mws-cmt-content a");i.text(i.text()),g=h[0]}v.find(".mws-cmt-list").prepend(g);var j=v.find(".shuo-cmt-count .count");j.text(+j.text()+1),d.val("").removeAttr("data-parentID").removeAttr("data-to").attr("placeholder",window.shuo.options.cmt_placeholder),autosize.update(a(".mws-editable")),d.removeClass("focus")}));else if(c.find(".mws-form-message").html(w),window.localStorage){var g="shuo_comment_"+shuo.options.threadID;localStorage.setItem(g,d.val())}}function l(){document.getElementById("SHUO_MAIN").scrollIntoView(!0)}function m(){var b=a(this).attr("data-page");window.shuo.api.page(b,function(b){l(),a("#SHUO_LIST").html(b),console.log(b),i(),autosize(a(".mws-editable"))})}function n(b){return(b.metaKey||b.ctrlKey)&&13===b.keyCode?(k.call(this),void b.preventDefault()):void a(this).parents(".mws-cmt-form").find(".mws-form-message").html("")}function o(){var b=a(this);if(!window.shuo.loginStatus)return b.hasClass("mws-main-star")?window.location.href="/login?return_to="+encodeURIComponent(window.location.href):void a(b.parents(".mws-cmt-item").find(".mws-item-message")[0]).html(w);var c=b.parents(".mws-cmt-item").length>0,d=c?b.parents(".mws-cmt-item").attr("id"):a("#SHUO_threadID").text();F||(F=!0,window.shuo.api.star({uuid:d,type:c?"comment":"thread"},function(a,c){return a?console.error(a):(F=!1,void b.toggleClass("mws-cmt-starred","").find(".mws-cmt-star").text(c.star))}))}function p(){return window.shuo.loginStatus?void a(this).atwho({at:"@",displayTpl:"<li> ${username} </li>",insertTpl:"@${username}",searchKey:"username",data:x}).addClass("focus"):window.location.href="/login?return_to="+encodeURIComponent(window.location.href)}function q(){D&&!a(this).val().trim()&&a(this).removeClass("focus")}function r(){var b=a(this),c=b.parents(".mws-cmt-item").attr("id"),d=window.confirm("确认删除该评论");d&&window.shuo.api.destroy({commentID:c},function(b,d){if(d&&d.result){a("#"+c).remove();var e=v.find(".shuo-cmt-count .count");e.text(e.text()-1)}else a(a("#"+c).find(".mws-item-message")[0]).text("删除失败, 请刷新重试")})}function s(){var b=a(this);b.parents(".mws-sort-list").find(".mws-btn-sort-active").removeClass("mws-btn-sort-active"),b.addClass("mws-btn-sort-active"),window.shuo.options.sort=b.attr("data-sortBy"),window.shuo.api.page(1,function(b){l(),a("#SHUO_LIST").html(b),i(),autosize(a(".mws-editable"))})}function t(){var b=a(window).scrollTop(),c=300,d=document.body.offsetHeight-(window.innerHeight+c)<=b;d&&A.hasMore&&!A.isLoading&&(A.isLoading=!0,window.shuo.api.page(++A.pageIndex,function(b){b.indexOf("mws-cmt-item")==-1?A.hasMore=!1:a("#SHUO_LIST").append(b),A.isLoading=!1}))}function u(){var b=a(".mws-btn-submit-mobile");a(this).addClass("focus"),a(this).val()?b.removeAttr("disabled"):b.attr("disabled",!0)}var v=a("#"+window.shuo.options.target),w="",x=[],y="#mainForm",z="请登录再评论",A={isLoading:!1,isFirstLoad:!0,pageIndex:1,hasMore:!1},B=window.shuo.options.version,C=window.shuo.options.debug,D=void 0===window.shuo.options.hasStar||window.shuo.options.hasStar;window.shuo.include("../css/shuo-new."+(C?"":B+".min.")+"css","css"),window.shuo.include("../css/jquery.atwho.css","css"),window.shuo.api.userSync(function(){window.shuo.api.load(function(h){v.html(h),b(),c(),i(),d();var j=a(".mws-editable");j.attr("rows",1),autosize(j),e(),f(),g()}),h()});var E=!1,F=!1;v.on("click",".mws-btn-reply",j),v.on("click",".mws-btn-star",o),v.on("click",".mws-form-submit",k),v.on("click",".mws-pagination li:not(.mws-page-disable):not(.mws-page-active)",m),v.on("click",".mws-btn-delete",r),v.on("click",".mws-btn-sort:not(.mws-btn-sort-active)",s),v.on("click",".mws-main-star",o),v.on("keydown",".mws-editable",n),v.on("focus",".mws-editable",p),v.on("blur",".mws-editable",q),v.on("keyup paste",".mws-editable",u),a(window).on("scroll",t)}(shuoQuery);