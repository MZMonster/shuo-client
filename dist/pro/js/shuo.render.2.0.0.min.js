!function(a){function b(){window.shuo.api.atSuggest(function(a,b){return a?console.log("get suggest error: ",a):void(w=b.suggest||[])})}function c(){var a="shuo_comment_"+shuo.options.threadID;localStorage&&localStorage.getItem(a)&&(u.find(".mws-cmt-form-wrapper .mws-editable").val(localStorage.getItem(a)),localStorage.removeItem(a,""))}function d(){var a=/(^|\?|&)shuo_cmt_id=([^&]*)(&|$)/,b=location.search,c=b.match(a);c&&(document.getElementById(c[2])?document.getElementById(c[2]).scrollIntoView(!0):i())}function e(){var a=/=$/g,b=window.shuo.options.user_login_url;a.test(b)&&(b+=encodeURIComponent(window.location.href+"#"+window.shuo.options.target)),v='请先<a href="'+b+'">登录</a>'}function f(){window.shuo.options.cmt_title&&a("#SHUO_title").text(window.shuo.options.cmt_title),window.shuo.options.cmt_placeholder&&a(".mws-editable").attr("placeholder",window.shuo.options.cmt_placeholder)}function g(){var b=a(this).parents(".mws-cmt-root"),c=a(a(this).parents(".mws-cmt-item")[0]),d=c.children().find(">.mws-cmt-item-form"),e=d.hasClass("mws-hidden");if(u.find(".mws-cmt-item-form").addClass("mws-hidden"),d.children().length)if(e){var f=d.find(".mws-form-content"),g=f.val();d.removeClass("mws-hidden"),f.val("").focus().val(g)}else d.addClass("mws-hidden");else{var h=b.parent().attr("id"),i=u.find(".mws-cmt-form-wrapper").children();i.find(".mws-form-message").text("");var j=i.clone(!0),k=j.find(".mws-form-controls"),l=a("<textarea>").addClass("mws-editable mws-form-content"),m=a(this).attr("data-to-username");l.attr({"data-to":a(this).attr("data-to"),"data-parentid":h,"data-emojiable":!0}),k.html(l),d.html(j).removeClass("mws-hidden"),window.emojiPicker.discover();var n=l.siblings(".emoji-wysiwyg-editor");if(m?(n.html("@"+m+" : "),l.val("").focus().val("@"+m+" : ")):n.html(""),n.focus(),n.html()){var o=document.createRange();o.selectNodeContents(n[0]),o.collapse(!1);var p=window.getSelection();p.removeAllRanges(),p.addRange(o)}q(b)}}function h(){var b=a(this),c=b.parents(".mws-cmt-form"),d=c.find(".mws-form-content"),e=new RegExp("\n","g"),f=c.find(".emoji-wysiwyg-editor");if(f.length&&!f.html())return void c.find(".mws-form-message").html("未输入评论内容");if(window.shuo.loginStatus)z||(b.attr("disabled",!0),z=!0,window.shuo.api.submit({content:d.val().replace(e,"  \n"),parentID:d.attr("data-parentID"),replyTo:d.attr("data-to")},function(e,f){if(z=!1,b.removeAttr("disabled"),e)return window.shuo.api.reqErrorHandle(e,function(a){c.find(".mws-form-message").text(a)});if(d.val(""),d.siblings(".emoji-wysiwyg-editor").html(""),d.css("height","auto"),d.attr("data-parentID")){d.attr("data-parentID")===a(c.parents(".mws-cmt-item")[0]).attr("id")?c.parents(".mws-cmt-root").find(">.mws-cmt-replies").prepend(f):a(c.parents(".mws-cmt-item")[0]).after(f);var g=c.parents(".mws-cmt-root").find(".mws-btn-moreReply");g.attr("data-count")&&g.attr("data-count",+g.attr("data-count")+1),c.parents(".mws-cmt-item-form").html("")}else{u.find(".mws-cmt-list").prepend(f),autosize(a("#"+a(f).attr("id")+" .mws-editable"));var h=u.find(".mws-cmt-count");h.text(+h.text()+1)}}));else if(c.find(".mws-form-message").html(v),window.localStorage){var g="shuo_comment_"+shuo.options.threadID;localStorage.setItem(g,d.val())}}function i(){document.getElementById("SHUO_MAIN").scrollIntoView(!0)}function j(){var b=a(this).attr("data-page");window.shuo.api.page(b,function(b){i(),a("#SHUO_LIST").html(b),f(),autosize(a(".mws-editable"))})}function k(b){return(b.metaKey||b.ctrlKey)&&13===b.keyCode?(h.call(this),void b.preventDefault()):void a(this).parents(".mws-cmt-form").find(".mws-form-message").html("")}function l(){var b=a(this);if(!window.shuo.loginStatus)return void a(b.parents(".mws-cmt-item").find(".mws-item-message")[0]).html(v);var c=b.parents(".mws-cmt-item").attr("id");window.shuo.api.star({uuid:c},function(a,c){return a?console.error(a):void b.toggleClass("mws-cmt-starred","").find(".mws-cmt-star").text(c.star)})}function m(){a(this).atwho({at:"@",displayTpl:"<li> ${username} </li>",insertTpl:"@${username}",searchKey:"username",data:w})}function n(){var b=a(this),c=b.parents(".mws-cmt-item").attr("id"),d=window.confirm("确认删除该评论");d&&window.shuo.api.destroy({commentID:c},function(b,d){if(d&&d.result){if(a("#"+c).remove(),d.isParent){var e=u.find(".mws-cmt-count");e.text(e.text()-1)}}else a(a("#"+c).find(".mws-item-message")[0]).text("删除失败, 请刷新重试")})}function o(){var b=a(this),c=b.prop("files")[0],d=b.parents(".mws-cmt-form").find(".emoji-wysiwyg-editor"),e=new function(a,b){var c=new RegExp("!\\["+b+"\\]\\(Uploading...\\)");this.uploading=function(){var c=a.html()+"!["+b+"](Uploading...)";return a.html(c).siblings(".mws-form-content").val(c)},this.succeed=function(d){var e=a.html().replace(c,"!["+b+"]("+d+")");return a.html(e).siblings(".mws-form-content").val(e)},this.failed=function(){var d=a.html().replace(c,"!["+b+"](Upload failed)");return a.html(d).siblings(".mws-form-content").val(d)}}(d,c.name);e.uploading(),window.shuo.api.uploadImg(c,function(a,b){try{return e.succeed(b.response[0].url+"!960")}catch(c){return e.failed()}})}function p(a){var b=a.find(">.mws-cmt-replies").children().length;b<+a.find(".mws-btn-moreReply").attr("data-count")||a.find(".mws-cmt-more").remove()}function q(a){a.removeClass("mws-cmt-firstload"),p(a)}function r(){var b=a(this),c=b.parents(".mws-cmt-root");if(c.hasClass("mws-cmt-firstload"))q(c);else{var d=+b.attr("data-page"),e=b.parents(".mws-cmt-item").attr("id");window.shuo.api.moreReplies({page:++d,commentID:e},function(f,g){return f?void a(a("#"+e).find(".mws-item-message")[0]).text("加载失败, 请刷新重试"):(b.attr("data-page",d),c.find(">.mws-cmt-replies").append(g),void p(c))})}}function s(){var b=a(this);b.parents(".mws-sort-list").find(".mws-btn-sort-active").removeClass("mws-btn-sort-active"),b.addClass("mws-btn-sort-active"),window.shuo.options.sort=b.attr("data-sortBy"),window.shuo.api.page(1,function(b){i(),a("#SHUO_LIST").html(b),f(),autosize(a(".mws-editable"))})}function t(){window.emojiPicker=new EmojiPicker({emojiable_selector:"[data-emojiable=true]",assetsPath:window.shuo.options.emoji_url,popupButtonClasses:"icon-shuo-smile",iconSize:20}),window.emojiPicker.discover()}var u=a("#"+window.shuo.options.target),v="",w=[],x=window.shuo.options.version,y=window.shuo.options.debug;window.shuo.include("../css/shuo-default."+(y?"":x+".min.")+"css","css"),window.shuo.include("../css/jquery.atwho.css","css"),window.shuo.api.userSync(function(){window.shuo.api.load(function(e){u.html(e),f(),b(),autosize(a(".mws-editable")),c(),d(),t()}),e()});var z=!1;u.on("click",".mws-btn-reply",g),u.on("click",".mws-btn-star",l),u.on("click",".mws-btn-submit",h),u.on("click",".mws-pagination li:not(.mws-page-disable):not(.mws-page-active)",j),u.on("click",".mws-btn-delete",n),u.on("click",".mws-btn-moreReply",r),u.on("click",".mws-btn-sort:not(.mws-btn-sort-active)",s),u.on("keydown",".mws-editable",k),u.on("focus",".mws-editable",m),u.on("change",".mws-input-uploadImg",o)}(shuoQuery);